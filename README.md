# ASAP_SourceCode
Python source code for ASAP and test data
The ASAP program is coded in python, and requires only three input files, as shown in Fig. 2 in the manuscript: 
	Input 1 holds the residue type assignments (RTAs) in the 3D NCACX spectrum, 
	Input 2 is the protein sequence, 
	Input 3 contains the peak list in the 3D NCOCX spectrum, 
They are specified by in the source code by NCACX_filename, protein_seq, and NCOCX_filename, respectively, as shown in Fig. 3C in the manuscript.

As shown in Fig. 3A and 3B, input 1 and 3 adopt an identical format: The first row holds two numbers, separated by a tab or space. The first number denotes the number of RTAs in input 1 or individual resonances in input 3. The second number denotes the number of CSs per entry in input 1 or 3. The maximum allowed CSs is 7, which could specify up to 5 non-carboxylic carbon CSs. Starting from the second row, the CSs of each entry are listed in the order of their 15N, c-alpha, carboxylic carbon, and any additional carbons. Their CS uncertainties are listed at corresponding columns after the last CS entry, estimated to be ~ ½ FWHM of the spectral linewidth. 

In input 3, if only three CSs of one resonance are listed per row, they should be listed in the order of the nitrogen, non-carboxylic carbon, and carboxylic carbon resonance frequencies of each signal((f_x,f_y,f_z), which means the CS coordinate of the non-carboxylic site along the direct detected dimension is entered as the second column. 

For both input 1 and 3 files, if the CS of a particular site is unknown, that entry is filled by 1e6, with its uncertainty set to 0.001. The last two columns of each row are the signal degeneracy and its RTA. Here signal degeneracy refers to how many carbon sites actually contribute signals to this resonance. At the beginning of an ASAP simulation, the RTA column in input 3 is just a place holder. In contrast, this field in input 1 describes its RTA in upper-cased single letters. Ambiguous RTAs are accepted as consecutive upper-cased single letters representing each possible assignment. 
 
If the sequential allocation is known (definitely assigned), the RTA column should be the upper-cased single letter for the residue type followed by its numeric position in both files. Definitely assigned RTAs and signals are exempted from match pairing by ARTIST, and their sequential positions are fixed in subsequent sequential assignment. 

Additionally, multiple resonances in NCOCX can be entered at a single row in input 3, as long as they share the indirect dimension frequencies and degeneracy values. Their common 15N and carboxylic carbon frequencies should be entered only once at the same row at the first and third columns, with the CSs of additional non-carboxylic carbons listed after the carboxylic carbon entry. The program will parse them into individual resonances (f_x,f_y,f_z).

To perform an ASAP simulation, all input files should be located in the same data folder as the ASAP script/source code. In addition to the three input files, users are expected to specify the following parameters, directly at the beginning section of the code, as shown in Fig. 3C in the manuscript:
	1.NCACX_filename: the file name of input 1, the RTAs in the NCACX spectrum.
	2. NCOCX_filename: the file name of input 3, the peak list in the NCOCX spectrum.
	3. protein_seq: the file name of input 2, comprising upper-cased single letter abbreviations of the amino acid sequence. 
	4. run_num: the number of parallel sequential assignment simulations by ASAP.
	5. scale: the variable scale in Eq. 2, to control the annealing slope.
	6. nattempt: the MC attempts per annealing step in the MCSA simulation, corresponds to nt in our discussion. For iterative simulations with parallel jobs, the recommended value is 5 million for proteins with 150 - 250 residues.
	7. final: a flag to control which kind of sequentially allocated RTAs in parallel simulations will be labeled as definitely assigned signals in output files. If final = 0, only those NCACX RTAs paired with a valid NCOCX matched RTA will be counted towards consistently assigned signals. If final = 1, all consistently allocated RTAs will be treated as definitely assigned signals. For better accuracy, it should be set to zero for iterative simulations, and revised to 1 for the final iteration.  
	8. nstep: the number of total annealing steps in MCSA. The recommended value is 40.
	9. w1f to w4f: correspond to variables w1f to w4f in Eq. 2, to control the penalty or bonus of ng, nb, ne, and nu. The recommended values for these coefficients are 20, 50, 10, and 5, respectively.
	10. N_mandate: the number of mandatory non-carboxylic carbon sites in the reference RTA to find a match in the second test of ARTIST. It is recommended to be set to 2, so only the CSs of two non-carboxylic carbon sites (typically c-alpha and c-beta) in the reference NCACX RTA are required to be matched by signals in NCOCX. All results in this work use N_mandate = 2.
	11. disparity_nco1: a positive number ≤ 1. The multiplication of disparity_nco1 with the listed uncertainty of the 15N CS in input 3 sets the uncertainty ∆f_bxi^kres in the final test according to Eq. 6. Usually, signals of the same site in the same residue in different spectra may exhibit some deviation, due to factors such as variations of sample conditions during spectra acquisition, field calibrations. This is captured by the uncertainty values listed in input 1 and 3, used for the first two tests in ARTIST according to Eqs. 9 and 10. However, when testing if signals belong to the same residue in the same spectrum, the alignment along their indirect dimensions should have a much tighter tolerance, no more than 0.2 ppm, or typically 0.1 ppm. 
	12. disparity_nco2: a positive number smaller  ≤ 1. The multiplication of disparity_nco2 with the listed uncertainty of the carboxylic carbon CS in input file 3 sets the uncertainty ∆f_byi^kres in the final test according to Eq. 7. Just like disparity_nco1, it modifies the tolerance of alignment of the second indirect dimension of resonances belonging to the same residue in NCOCX. 

In practice, users only need to update the values for parameters listed in 1 to 7, keeping the rest as recommended. Disparity_nco1 and disparity_nco2 may be revised according to the spectral quality or users’ preferred rigor. 

Before initiating an ASAP simulation, users are advised to use python script Plot_survivability based on Eqs. 11 and 12 to set parameters scale and nattempt, demonstrated in Fig. 4D. Alternatively, they can refer their project parameters (protein size and amino acid composition, spectral quality) to the examples in this work to set these parameters properly. Optimized values of scale and nattempt should maximize the number of effective annealing steps. In simple words, it should maximize the annealing steps with nattempt ≥ N_a (n_g=2). Meanwhile, there should be a few annealing steps with nattempt ≤ N_a (n_g=1).

The general workflow of ASAP is described by Fig. 2. The program first uses ARTST to find the matched RTAs in NCOCX for each reference RTA in NCACX. The results are summarized in the file NCO_MatchSummary, as shown in Fig. S1, with details listed in file NCO_MatchDetail. The number of matched RTAs for each RTA in NCACX is stored in file knmatch_rd, which is used to generate the plot shown in Fig. 4A by python script Plot_nmatch.

After match pairing, ARTIST identifies those RTA matched pairs implicated in type 2 local minima, and records the number in file Overlap. Users can inspect the content, as plotted in Fig. S2.   

Next, the program proceeds to determine the sequential allocations of these matched RTA pairs by the MCSA algorithm as described above. If the protein is small and ambiguity in RTAs is low, most of the RTAs finds a unique matched RTA in NCOCX, with low values in Overlap, users may try a single MCSA simulation with a high nattempt. However, most of ssNMR projects probably need iterative parallel simulations due to the less-than-ideal spectral quality. The progress of the ASAP simulation is recorded in file runrecord. When each parallel simulation ends, the final values of  n_g,n_b,n_e, n_u are recorded in file runsummary. Each parallel simulation also updates the RTA columns of RTAs that are successfully assigned, reported in NCACXbknum and NCOCXbknum, in the same format as the input files, where num is the job index in the parallel simulations. When all parallel simulations are completed, the program identifies those RTAs being consistently allocated and generate another pair of output files NCACX4nextrd and NCOCX4nextrd. In these files, only the RTA columns of those consistently assigned RTAs are revised to their allocated residue positions. 

The consistently allocated RTAs of all parallel simulations can be plotted together with the number of matched RTAs for each NCACX RTA by python script Plot_nmatch, as shown in Fig. 4A. The progress of n_g,n_b,n_e, n_u along an MCSA simulation can be plotted by python script Plot_numbers, as shown in Fig. 4B. The dynamic occupancy at each residue position can be visualized by python script Plot_occupancy_sum, as shown in Fig. 4C. 

After all parallel simulations end, if a new iteration should be performed, protein_seq, NCACX4nextrd and NCOCX4nextrd can be copied to a new folder, together with the ASAP script. The names of NCACX4nextrd and NCOCX4nextrd should be revised as the new input 1 and 3 to start the new iteration.  
